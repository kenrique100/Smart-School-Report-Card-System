<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Student - Student Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
<div class="max-w-6xl mx-auto mt-6 bg-white shadow-lg rounded-lg p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Add New Student</h1>
        <a th:href="@{/students}" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
            <i class="fas fa-arrow-left mr-2"></i>Back to Students
        </a>
    </div>

    <!-- Success/Error Messages -->
    <div th:if="${error}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        <span th:text="${error}"></span>
    </div>

    <form th:action="@{/students/save}" th:object="${student}" method="post" class="space-y-6">
        <!-- Personal Information -->
        <div class="bg-blue-50 p-4 rounded-lg">
            <h2 class="text-lg font-semibold text-blue-800 mb-4">
                <i class="fas fa-user mr-2"></i>Personal Information
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                    <input type="text" th:field="*{firstName}" required
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                    <input type="text" th:field="*{lastName}" required
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth *</label>
                    <input type="date" th:field="*{dateOfBirth}" required
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Gender *</label>
                    <select th:field="*{gender}" required
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select Gender</option>
                        <option value="MALE">Male</option>
                        <option value="FEMALE">Female</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" th:field="*{email}"
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                    <textarea th:field="*{address}" rows="3"
                              class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
            </div>
        </div>

        <!-- Academic Information -->
        <div class="bg-green-50 p-4 rounded-lg">
            <h2 class="text-lg font-semibold text-green-800 mb-4">
                <i class="fas fa-graduation-cap mr-2"></i>Academic Information
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Classroom *</label>
                    <select th:field="*{classRoom}" required
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                            onchange="handleClassChange(this)">
                        <option value="">Select Classroom</option>
                        <option th:each="c : ${classRooms}"
                                th:value="${c.id}"
                                th:text="${c.name}"
                                th:attr="data-code=${c.code}"></option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Department *</label>
                    <select th:field="*{department}" required
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                            onchange="handleDepartmentChange(this)">
                        <option value="">Select Department</option>
                        <option th:each="d : ${departments}"
                                th:value="${d.id}"
                                th:text="${d.name}"
                                th:attr="data-code=${d.code}"></option>
                    </select>
                </div>
                <div id="specialtyField">
                    <label class="block text-sm font-medium text-gray-700 mb-1" id="specialtyLabel">Specialty</label>
                    <select th:field="*{specialty}" id="specialtySelect"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                            onchange="handleSpecialtyChange()">
                        <option value="">Select Specialty</option>
                        <option th:each="specialty : ${specialties}"
                                th:value="${specialty}"
                                th:text="${specialty}"></option>
                    </select>
                    <div id="specialtyHelp" class="text-sm text-gray-500 mt-1"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Academic Year Start *</label>
                        <select th:field="*{academicYearStart}" required
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select Start Year</option>
                            <option th:each="year : ${#numbers.sequence(2020, 2030)}"
                                    th:value="${year}" th:text="${year}"></option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Academic Year End *</label>
                        <select th:field="*{academicYearEnd}" required
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select End Year</option>
                            <option th:each="year : ${#numbers.sequence(2021, 2031)}"
                                    th:value="${year}" th:text="${year}"></option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subject Selection -->
        <div class="bg-purple-50 p-4 rounded-lg">
            <h2 class="text-lg font-semibold text-purple-800 mb-4">
                <i class="fas fa-book mr-2"></i>Subject Selection
            </h2>

            <!-- Compulsory Subjects -->
            <div id="compulsorySubjects" class="mb-6 hidden">
                <h3 class="text-md font-semibold text-green-700 mb-3 flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>Compulsory Subjects
                </h3>
                <div id="compulsorySubjectsList" class="grid grid-cols-1 md:grid-cols-2 gap-3 p-3 bg-green-100 rounded-lg">
                    <!-- Compulsory subjects will be loaded here -->
                </div>
            </div>

            <!-- Department Subjects -->
            <div id="departmentSubjects" class="mb-6 hidden">
                <h3 class="text-md font-semibold text-blue-700 mb-3 flex items-center">
                    <i class="fas fa-building mr-2"></i>Department Subjects
                </h3>
                <div id="departmentSubjectsList" class="grid grid-cols-1 md:grid-cols-2 gap-3 p-3 bg-blue-100 rounded-lg">
                    <!-- Department subjects will be loaded here -->
                </div>
            </div>

            <!-- Optional Subjects -->
            <div id="optionalSubjects" class="mb-6 hidden">
                <h3 class="text-md font-semibold text-purple-700 mb-3 flex items-center">
                    <i class="fas fa-list-alt mr-2"></i>Optional Subjects
                </h3>
                <div id="optionalSubjectsList" class="grid grid-cols-1 md:grid-cols-2 gap-3 p-3 bg-purple-100 rounded-lg">
                    <!-- Optional subjects will be loaded here -->
                </div>
            </div>

            <!-- No Subjects Message -->
            <div id="noSubjectsMessage" class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded hidden">
                <i class="fas fa-info-circle mr-2"></i>
                No subjects available for the selected criteria. Please select a class and department first.
            </div>
        </div>

        <div class="flex justify-end space-x-3 pt-4 border-t">
            <a th:href="@{/students}" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">Cancel</a>
            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                <i class="fas fa-save mr-2"></i>Save Student
            </button>
        </div>
    </form>
</div>

<script>
    let currentClassCode = '';
    let currentDepartmentId = '';
    let currentSpecialty = '';

    async function updateSpecialtyRequirements(classCode, departmentCode) {
        if (!classCode || !departmentCode) {
            resetSpecialtyField();
            return;
        }

        try {
            const response = await fetch(`/students/check-specialty-requirements?classCode=${classCode}&departmentCode=${departmentCode}`);
            const requirement = await response.json();

            const specialtyField = document.getElementById('specialtyField');
            const specialtyLabel = document.getElementById('specialtyLabel');
            const specialtySelect = document.getElementById('specialtySelect');
            const specialtyHelp = document.getElementById('specialtyHelp');

            if (!requirement.allowed) {
                specialtyField.style.display = 'none';
                specialtySelect.value = '';
                currentSpecialty = '';
            } else {
                specialtyField.style.display = 'block';

                if (requirement.required) {
                    specialtyLabel.innerHTML = 'Specialty <span class="text-red-500">*</span>';
                    specialtySelect.setAttribute('required', 'required');
                    specialtyHelp.textContent = 'Specialty is required for Sixth Form Science/Arts students';
                    specialtyHelp.className = 'text-sm text-red-500 mt-1';
                } else {
                    specialtyLabel.textContent = 'Specialty';
                    specialtySelect.removeAttribute('required');
                    specialtyHelp.textContent = 'Specialty is optional';
                    specialtyHelp.className = 'text-sm text-gray-500 mt-1';
                }
            }

            updateSpecialtyOptions(requirement.specialties);
            await loadGroupedSubjects();

        } catch (error) {
            console.error('Error checking specialty requirements:', error);
            resetSpecialtyField();
        }
    }

    function resetSpecialtyField() {
        const specialtyField = document.getElementById('specialtyField');
        const specialtyLabel = document.getElementById('specialtyLabel');
        const specialtySelect = document.getElementById('specialtySelect');
        const specialtyHelp = document.getElementById('specialtyHelp');

        specialtyField.style.display = 'block';
        specialtyLabel.textContent = 'Specialty';
        specialtySelect.removeAttribute('required');
        specialtyHelp.textContent = '';
    }

    function updateSpecialtyOptions(specialties) {
        const specialtySelect = document.getElementById('specialtySelect');

        // Clear existing options except the first one
        while (specialtySelect.options.length > 1) {
            specialtySelect.remove(1);
        }

        // Add new options
        specialties.forEach(specialty => {
            const option = document.createElement('option');
            option.value = specialty;
            option.textContent = specialty;
            specialtySelect.appendChild(option);
        });
    }

    async function loadGroupedSubjects() {
        if (!currentClassCode || !currentDepartmentId) {
            hideAllSubjectSections();
            document.getElementById('noSubjectsMessage').classList.remove('hidden');
            return;
        }

        try {
            const url = `/students/grouped-subjects?classCode=${currentClassCode}&departmentId=${currentDepartmentId}&specialty=${currentSpecialty || ''}`;
            const response = await fetch(url);
            const groupedSubjects = await response.json();

            displayGroupedSubjects(groupedSubjects);

        } catch (error) {
            console.error('Error loading grouped subjects:', error);
            hideAllSubjectSections();
            document.getElementById('noSubjectsMessage').classList.remove('hidden');
        }
    }

    function displayGroupedSubjects(groupedSubjects) {
        hideAllSubjectSections();

        let hasSubjects = false;

        // Display compulsory subjects
        if (groupedSubjects.compulsory && groupedSubjects.compulsory.length > 0) {
            displaySubjectGroup('compulsory', groupedSubjects.compulsory, true);
            hasSubjects = true;
        }

        // Display department subjects
        if (groupedSubjects.department && groupedSubjects.department.length > 0) {
            displaySubjectGroup('department', groupedSubjects.department, false);
            hasSubjects = true;
        }

        // Display optional subjects
        if (groupedSubjects.optional && groupedSubjects.optional.length > 0) {
            displaySubjectGroup('optional', groupedSubjects.optional, false);
            hasSubjects = true;
        }

        if (hasSubjects) {
            document.getElementById('noSubjectsMessage').classList.add('hidden');
        } else {
            document.getElementById('noSubjectsMessage').classList.remove('hidden');
        }
    }

    function displaySubjectGroup(type, subjects, isCompulsory) {
        const container = document.getElementById(type + 'Subjects');
        const list = document.getElementById(type + 'SubjectsList');

        list.innerHTML = '';

        subjects.forEach(subject => {
            const subjectDiv = document.createElement('div');
            subjectDiv.className = 'flex items-center space-x-3 p-2 bg-white rounded border';

            const checkboxId = `subject_${subject.id}`;
            const isChecked = isCompulsory ? 'checked' : '';
            const isDisabled = isCompulsory ? 'disabled' : '';

            subjectDiv.innerHTML = `
                <input type="checkbox" id="${checkboxId}"
                       name="subjectIds" value="${subject.id}"
                       ${isChecked} ${isDisabled}
                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <label for="${checkboxId}" class="flex-1">
                    <span class="font-medium">${subject.name}</span>
                    <div class="text-xs text-gray-600 mt-1">
                        <span>Code: ${subject.subjectCode}</span> |
                        <span>Coefficient: ${subject.coefficient}</span>
                        ${subject.specialty ? ` | <span>Specialty: ${subject.specialty}</span>` : ''}
                    </div>
                </label>
                ${isCompulsory ? '<span class="text-xs bg-green-500 text-white px-2 py-1 rounded">Compulsory</span>' : ''}
            `;

            list.appendChild(subjectDiv);
        });

        container.classList.remove('hidden');
    }

    function hideAllSubjectSections() {
        document.getElementById('compulsorySubjects').classList.add('hidden');
        document.getElementById('departmentSubjects').classList.add('hidden');
        document.getElementById('optionalSubjects').classList.add('hidden');
        document.getElementById('noSubjectsMessage').classList.add('hidden');
    }

    function handleClassChange(select) {
        const selectedOption = select.options[select.selectedIndex];
        currentClassCode = selectedOption.getAttribute('data-code');

        const departmentSelect = document.querySelector('select[th\\:field="*{department}"]');
        if (departmentSelect && departmentSelect.value) {
            const selectedDeptOption = departmentSelect.options[departmentSelect.selectedIndex];
            const departmentCode = selectedDeptOption.getAttribute('data-code');
            currentDepartmentId = departmentSelect.value;

            updateSpecialtyRequirements(currentClassCode, departmentCode);
        } else {
            hideAllSubjectSections();
            document.getElementById('noSubjectsMessage').classList.remove('hidden');
        }
    }

    function handleDepartmentChange(select) {
        const selectedOption = select.options[select.selectedIndex];
        const departmentCode = selectedOption.getAttribute('data-code');
        currentDepartmentId = select.value;

        const classSelect = document.querySelector('select[th\\:field="*{classRoom}"]');
        if (classSelect && classSelect.value) {
            const selectedClassOption = classSelect.options[classSelect.selectedIndex];
            currentClassCode = selectedClassOption.getAttribute('data-code');

            updateSpecialtyRequirements(currentClassCode, departmentCode);
        } else {
            hideAllSubjectSections();
            document.getElementById('noSubjectsMessage').classList.remove('hidden');
        }
    }

    function handleSpecialtyChange() {
        const specialtySelect = document.getElementById('specialtySelect');
        currentSpecialty = specialtySelect.value;
        loadGroupedSubjects();
    }

    // Auto-set end year based on start year
    document.addEventListener('DOMContentLoaded', function() {
        const startYearSelect = document.querySelector('select[th\\:field="*{academicYearStart}"]');
        const endYearSelect = document.querySelector('select[th\\:field="*{academicYearEnd}"]');

        if (startYearSelect) {
            startYearSelect.addEventListener('change', function() {
                const startYear = parseInt(this.value);
                if (startYear && !isNaN(startYear)) {
                    endYearSelect.value = startYear + 1;
                }
            });
        }

        // Initialize with current values if any
        const classSelect = document.querySelector('select[th\\:field="*{classRoom}"]');
        const departmentSelect = document.querySelector('select[th\\:field="*{department}"]');

        if (classSelect && classSelect.value) {
            handleClassChange(classSelect);
        }
        if (departmentSelect && departmentSelect.value) {
            handleDepartmentChange(departmentSelect);
        }
    });
</script>
</body>
</html>