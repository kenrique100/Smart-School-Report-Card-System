<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Student - Student Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .subject-group {
            transition: all 0.3s ease;
        }
        .compulsory-badge {
            background-color: #10B981;
            color: white;
        }
        .department-badge {
            background-color: #3B82F6;
            color: white;
        }
        .optional-badge {
            background-color: #8B5CF6;
            color: white;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50">
<div class="max-w-7xl mx-auto mt-6 bg-white shadow-lg rounded-lg p-6 fade-in">
    <div class="flex justify-between items-center mb-6 pb-4 border-b">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Edit Student</h1>
            <p class="text-gray-600 mt-1">Update student information and subject selection</p>
        </div>
        <a th:href="@{/students}" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>Back to Students
        </a>
    </div>

    <!-- Success/Error Messages -->
    <div th:if="${param.success}" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
        <i class="fas fa-check-circle mr-2"></i>
        <span th:text="${param.success}">Student updated successfully!</span>
    </div>

    <div th:if="${error}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        <span th:text="${error}"></span>
    </div>

    <form th:action="@{'/students/update/' + ${student.id}}" th:object="${student}" method="post" class="space-y-6">
        <!-- Personal Information -->
        <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
            <h2 class="text-lg font-semibold text-blue-800 mb-4 flex items-center">
                <i class="fas fa-user-circle mr-3"></i>Personal Information
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                    <input type="text" th:field="*{firstName}" required
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                    <input type="text" th:field="*{lastName}" required
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date of Birth *</label>
                    <input type="date" th:field="*{dateOfBirth}" required
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Gender *</label>
                    <select th:field="*{gender}" required
                            class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                        <option value="">Select Gender</option>
                        <option value="MALE">Male</option>
                        <option value="FEMALE">Female</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" th:field="*{email}"
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                    <textarea th:field="*{address}" rows="3"
                              class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"></textarea>
                </div>
            </div>
        </div>

        <!-- Academic Information -->
        <div class="bg-green-50 p-6 rounded-lg border border-green-200">
            <h2 class="text-lg font-semibold text-green-800 mb-4 flex items-center">
                <i class="fas fa-graduation-cap mr-3"></i>Academic Information
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Classroom *</label>
                    <select th:field="*{classRoom}" required
                            class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                            onchange="handleClassChange(this)">
                        <option value="">Select Classroom</option>
                        <option th:each="c : ${classRooms}"
                                th:value="${c.id}"
                                th:text="${c.name}"
                                th:attr="data-code=${c.code}"></option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Department *</label>
                    <select th:field="*{department}" required
                            class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                            onchange="handleDepartmentChange(this)">
                        <option value="">Select Department</option>
                        <option th:each="d : ${departments}"
                                th:value="${d.id}"
                                th:text="${d.name}"
                                th:attr="data-code=${d.code}"></option>
                    </select>
                </div>
                <div id="specialtyField">
                    <label class="block text-sm font-medium text-gray-700 mb-2" id="specialtyLabel">Specialty</label>
                    <select th:field="*{specialty}" id="specialtySelect"
                            class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                            onchange="handleSpecialtyChange()">
                        <option value="">Select Specialty</option>
                        <option th:each="specialty : ${specialties}"
                                th:value="${specialty}"
                                th:text="${specialty}"></option>
                    </select>
                    <div id="specialtyHelp" class="text-sm mt-2"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Academic Year Start *</label>
                        <select th:field="*{academicYearStart}" required
                                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            <option value="">Select Start Year</option>
                            <option th:each="year : ${#numbers.sequence(2020, 2030)}"
                                    th:value="${year}" th:text="${year}"></option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Academic Year End *</label>
                        <select th:field="*{academicYearEnd}" required
                                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            <option value="">Select End Year</option>
                            <option th:each="year : ${#numbers.sequence(2021, 2031)}"
                                    th:value="${year}" th:text="${year}"></option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subject Selection -->
        <div class="bg-purple-50 p-6 rounded-lg border border-purple-200">
            <h2 class="text-lg font-semibold text-purple-800 mb-4 flex items-center">
                <i class="fas fa-book-open mr-3"></i>Subject Selection
            </h2>

            <div class="mb-4 p-4 bg-white rounded-lg border">
                <h3 class="text-md font-semibold text-gray-700 mb-3">Available Subjects Based on Selection</h3>
                <p class="text-sm text-gray-600">Subjects are automatically filtered based on the selected class, department, and specialty.</p>
            </div>

            <!-- Compulsory Subjects -->
            <div id="compulsorySubjects" class="subject-group mb-6">
                <h3 class="text-md font-semibold text-green-700 mb-3 flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>Compulsory Subjects
                    <span class="compulsory-badge text-xs px-2 py-1 rounded-full ml-2" id="compulsoryCount">0</span>
                </h3>
                <div id="compulsorySubjectsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4 bg-green-50 rounded-lg border border-green-200">
                    <!-- Compulsory subjects will be loaded here -->
                </div>
            </div>

            <!-- Department Subjects -->
            <div id="departmentSubjects" class="subject-group mb-6">
                <h3 class="text-md font-semibold text-blue-700 mb-3 flex items-center">
                    <i class="fas fa-building mr-2"></i>Department Subjects
                    <span class="department-badge text-xs px-2 py-1 rounded-full ml-2" id="departmentCount">0</span>
                </h3>
                <div id="departmentSubjectsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <!-- Department subjects will be loaded here -->
                </div>
            </div>

            <!-- Optional Subjects -->
            <div id="optionalSubjects" class="subject-group mb-6">
                <h3 class="text-md font-semibold text-purple-700 mb-3 flex items-center">
                    <i class="fas fa-list-alt mr-2"></i>Optional Subjects
                    <span class="optional-badge text-xs px-2 py-1 rounded-full ml-2" id="optionalCount">0</span>
                </h3>
                <div id="optionalSubjectsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <!-- Optional subjects will be loaded here -->
                </div>
            </div>

            <!-- No Subjects Message -->
            <div id="noSubjectsMessage" class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded hidden">
                <i class="fas fa-info-circle mr-2"></i>
                No subjects available for the selected criteria. Please select a class and department first.
            </div>

            <!-- Current Subjects Summary -->
            <div th:if="${not studentSubjects.empty}" class="mt-6 p-4 bg-gray-50 rounded-lg border">
                <h4 class="text-md font-semibold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-chart-line mr-2"></i>Current Enrollment Summary
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div class="text-center p-3 bg-white rounded border">
                        <div class="text-2xl font-bold text-blue-600" th:text="${studentSubjects.size()}">0</div>
                        <div class="text-sm text-gray-600">Total Subjects</div>
                    </div>
                    <div class="text-center p-3 bg-white rounded border">
                        <div class="text-2xl font-bold text-green-600"
                             th:text="${#lists.size(studentSubjects.?[isCompulsory == true])}">0</div>
                        <div class="text-sm text-gray-600">Compulsory</div>
                    </div>
                    <div class="text-center p-3 bg-white rounded border">
                        <div class="text-2xl font-bold text-blue-600"
                             th:text="${#lists.size(studentSubjects.?[isCompulsory == false])}">0</div>
                        <div class="text-sm text-gray-600">Optional</div>
                    </div>
                    <div class="text-center p-3 bg-white rounded border">
                        <div class="text-2xl font-bold text-purple-600"
                             th:text="${#lists.size(studentSubjects.?[score != null])}">0</div>
                        <div class="text-sm text-gray-600">With Scores</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-end space-x-4 pt-6 border-t">
            <a th:href="@{/students}" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">
                Cancel
            </a>
            <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                <i class="fas fa-save mr-2"></i>Update Student
            </button>
        </div>
    </form>
</div>

<script>
    let currentClassCode = '';
    let currentDepartmentId = '';
    let currentSpecialty = '';
    let selectedSubjectIds = [];

    // Initialize with current student data
    document.addEventListener('DOMContentLoaded', function() {
        // Get current values from form
        const classSelect = document.querySelector('select[th\\:field="*{classRoom}"]');
        const departmentSelect = document.querySelector('select[th\\:field="*{department}"]');
        const specialtySelect = document.getElementById('specialtySelect');

        if (classSelect && classSelect.value) {
            const selectedClassOption = classSelect.options[classSelect.selectedIndex];
            currentClassCode = selectedClassOption.getAttribute('data-code');
        }

        if (departmentSelect && departmentSelect.value) {
            const selectedDeptOption = departmentSelect.options[departmentSelect.selectedIndex];
            const departmentCode = selectedDeptOption.getAttribute('data-code');
            currentDepartmentId = departmentSelect.value;
        }

        if (specialtySelect && specialtySelect.value) {
            currentSpecialty = specialtySelect.value;
        }

        // Get pre-selected subject IDs from Thymeleaf
        selectedSubjectIds = JSON.parse('[[${selectedSubjectIds}]]') || [];

        // Load initial subjects
        if (currentClassCode && currentDepartmentId) {
            updateSpecialtyRequirements(currentClassCode,
                document.querySelector('select[th\\:field="*{department}"] option:checked')?.getAttribute('data-code'));
            loadGroupedSubjects();
        }

        // Auto-set end year based on start year
        const startYearSelect = document.querySelector('select[th\\:field="*{academicYearStart}"]');
        const endYearSelect = document.querySelector('select[th\\:field="*{academicYearEnd}"]');

        if (startYearSelect) {
            startYearSelect.addEventListener('change', function() {
                const startYear = parseInt(this.value);
                if (startYear && !isNaN(startYear)) {
                    endYearSelect.value = startYear + 1;
                }
            });
        }
    });

    async function updateSpecialtyRequirements(classCode, departmentCode) {
        if (!classCode || !departmentCode) {
            resetSpecialtyField();
            return;
        }

        try {
            const response = await fetch(`/students/check-specialty-requirements?classCode=${classCode}&departmentCode=${departmentCode}`);
            const requirement = await response.json();

            const specialtyField = document.getElementById('specialtyField');
            const specialtyLabel = document.getElementById('specialtyLabel');
            const specialtySelect = document.getElementById('specialtySelect');
            const specialtyHelp = document.getElementById('specialtyHelp');

            if (!requirement.allowed) {
                specialtyField.style.display = 'none';
                specialtySelect.value = '';
                currentSpecialty = '';
            } else {
                specialtyField.style.display = 'block';

                if (requirement.required) {
                    specialtyLabel.innerHTML = 'Specialty <span class="text-red-500">*</span>';
                    specialtySelect.setAttribute('required', 'required');
                    specialtyHelp.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i>Specialty is required for Sixth Form Science/Arts students';
                    specialtyHelp.className = 'text-sm text-red-600 mt-1 flex items-center';
                } else {
                    specialtyLabel.textContent = 'Specialty';
                    specialtySelect.removeAttribute('required');
                    specialtyHelp.innerHTML = '<i class="fas fa-info-circle mr-1"></i>Specialty is optional';
                    specialtyHelp.className = 'text-sm text-gray-600 mt-1 flex items-center';
                }
            }

            updateSpecialtyOptions(requirement.specialties);
            await loadGroupedSubjects();

        } catch (error) {
            console.error('Error checking specialty requirements:', error);
            resetSpecialtyField();
        }
    }

    function resetSpecialtyField() {
        const specialtyField = document.getElementById('specialtyField');
        const specialtyLabel = document.getElementById('specialtyLabel');
        const specialtySelect = document.getElementById('specialtySelect');
        const specialtyHelp = document.getElementById('specialtyHelp');

        specialtyField.style.display = 'block';
        specialtyLabel.textContent = 'Specialty';
        specialtySelect.removeAttribute('required');
        specialtyHelp.textContent = '';
    }

    function updateSpecialtyOptions(specialties) {
        const specialtySelect = document.getElementById('specialtySelect');

        // Clear existing options except the first one
        while (specialtySelect.options.length > 1) {
            specialtySelect.remove(1);
        }

        // Add new options
        specialties.forEach(specialty => {
            const option = document.createElement('option');
            option.value = specialty;
            option.textContent = specialty;
            specialtySelect.appendChild(option);
        });

        // Restore current specialty if it exists in new options
        if (currentSpecialty) {
            specialtySelect.value = currentSpecialty;
        }
    }

    async function loadGroupedSubjects() {
        if (!currentClassCode || !currentDepartmentId) {
            hideAllSubjectSections();
            document.getElementById('noSubjectsMessage').classList.remove('hidden');
            return;
        }

        try {
            const url = `/students/grouped-subjects?classCode=${currentClassCode}&departmentId=${currentDepartmentId}&specialty=${currentSpecialty || ''}`;
            const response = await fetch(url);
            const groupedSubjects = await response.json();

            displayGroupedSubjects(groupedSubjects);
            preSelectSubjects();

        } catch (error) {
            console.error('Error loading grouped subjects:', error);
            hideAllSubjectSections();
            document.getElementById('noSubjectsMessage').classList.remove('hidden');
        }
    }

    function displayGroupedSubjects(groupedSubjects) {
        hideAllSubjectSections();

        let hasSubjects = false;

        // Display compulsory subjects
        if (groupedSubjects.compulsory && groupedSubjects.compulsory.length > 0) {
            displaySubjectGroup('compulsory', groupedSubjects.compulsory, true);
            document.getElementById('compulsoryCount').textContent = groupedSubjects.compulsory.length;
            hasSubjects = true;
        }

        // Display department subjects
        if (groupedSubjects.department && groupedSubjects.department.length > 0) {
            displaySubjectGroup('department', groupedSubjects.department, false);
            document.getElementById('departmentCount').textContent = groupedSubjects.department.length;
            hasSubjects = true;
        }

        // Display optional subjects
        if (groupedSubjects.optional && groupedSubjects.optional.length > 0) {
            displaySubjectGroup('optional', groupedSubjects.optional, false);
            document.getElementById('optionalCount').textContent = groupedSubjects.optional.length;
            hasSubjects = true;
        }

        if (hasSubjects) {
            document.getElementById('noSubjectsMessage').classList.add('hidden');
        } else {
            document.getElementById('noSubjectsMessage').classList.remove('hidden');
        }
    }

    function displaySubjectGroup(type, subjects, isCompulsory) {
        const container = document.getElementById(type + 'Subjects');
        const list = document.getElementById(type + 'SubjectsList');

        list.innerHTML = '';

        subjects.forEach(subject => {
            const subjectDiv = document.createElement('div');
            subjectDiv.className = 'bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition-shadow';

            const checkboxId = `subject_${subject.id}`;
            const isChecked = isCompulsory ? 'checked' : '';
            const isDisabled = isCompulsory ? 'disabled' : '';
            const badgeClass = isCompulsory ? 'compulsory-badge' :
                type === 'department' ? 'department-badge' : 'optional-badge';
            const badgeText = isCompulsory ? 'Compulsory' :
                type === 'department' ? 'Department' : 'Optional';

            subjectDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <input type="checkbox" id="${checkboxId}"
                           name="subjectIds" value="${subject.id}"
                           ${isChecked} ${isDisabled}
                           class="mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500 transition-colors">
                    <div class="flex-1">
                        <label for="${checkboxId}" class="block font-medium text-gray-900 cursor-pointer">
                            ${subject.name}
                        </label>
                        <div class="text-sm text-gray-600 mt-1 space-y-1">
                            <div><span class="font-medium">Code:</span> ${subject.subjectCode}</div>
                            <div><span class="font-medium">Coefficient:</span> ${subject.coefficient}</div>
                            ${subject.specialty ? `<div><span class="font-medium">Specialty:</span> ${subject.specialty}</div>` : ''}
                            ${subject.description ? `<div><span class="font-medium">Description:</span> ${subject.description}</div>` : ''}
                        </div>
                        <span class="text-xs ${badgeClass} px-2 py-1 rounded-full mt-2 inline-block">
                            ${badgeText}
                        </span>
                    </div>
                </div>
            `;

            list.appendChild(subjectDiv);
        });

        container.classList.remove('hidden');
    }

    function preSelectSubjects() {
        selectedSubjectIds.forEach(subjectId => {
            const checkbox = document.querySelector(`input[name="subjectIds"][value="${subjectId}"]`);
            if (checkbox && !checkbox.disabled) {
                checkbox.checked = true;
            }
        });
    }

    function hideAllSubjectSections() {
        document.getElementById('compulsorySubjects').classList.add('hidden');
        document.getElementById('departmentSubjects').classList.add('hidden');
        document.getElementById('optionalSubjects').classList.add('hidden');
        document.getElementById('noSubjectsMessage').classList.add('hidden');
    }

    function handleClassChange(select) {
        const selectedOption = select.options[select.selectedIndex];
        currentClassCode = selectedOption.getAttribute('data-code');

        const departmentSelect = document.querySelector('select[th\\:field="*{department}"]');
        if (departmentSelect && departmentSelect.value) {
            const selectedDeptOption = departmentSelect.options[departmentSelect.selectedIndex];
            const departmentCode = selectedDeptOption.getAttribute('data-code');
            currentDepartmentId = departmentSelect.value;

            updateSpecialtyRequirements(currentClassCode, departmentCode);
        } else {
            hideAllSubjectSections();
            document.getElementById('noSubjectsMessage').classList.remove('hidden');
        }
    }

    function handleDepartmentChange(select) {
        const selectedOption = select.options[select.selectedIndex];
        const departmentCode = selectedOption.getAttribute('data-code');
        currentDepartmentId = select.value;

        const classSelect = document.querySelector('select[th\\:field="*{classRoom}"]');
        if (classSelect && classSelect.value) {
            const selectedClassOption = classSelect.options[classSelect.selectedIndex];
            currentClassCode = selectedClassOption.getAttribute('data-code');

            updateSpecialtyRequirements(currentClassCode, departmentCode);
        } else {
            hideAllSubjectSections();
            document.getElementById('noSubjectsMessage').classList.remove('hidden');
        }
    }

    function handleSpecialtyChange() {
        const specialtySelect = document.getElementById('specialtySelect');
        currentSpecialty = specialtySelect.value;
        loadGroupedSubjects();
    }

    // Select all checkboxes in a section
    function selectAllSubjects(type) {
        const checkboxes = document.querySelectorAll(`#${type}SubjectsList input[type="checkbox"]:not(:disabled)`);
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
    }

    // Deselect all checkboxes in a section
    function deselectAllSubjects(type) {
        const checkboxes = document.querySelectorAll(`#${type}SubjectsList input[type="checkbox"]:not(:disabled)`);
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
    }
</script>
</body>
</html>