<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit Student</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
<div class="max-w-3xl mx-auto mt-10 bg-white shadow-lg rounded-lg p-6">
    <h1 class="text-2xl font-bold mb-4 text-gray-800">Edit Student</h1>

    <form th:action="@{'/students/update/' + ${student.id}}" th:object="${student}" method="post" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium">First Name *</label>
                <input type="text" th:field="*{firstName}" class="w-full border rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-sm font-medium">Last Name *</label>
                <input type="text" th:field="*{lastName}" class="w-full border rounded px-3 py-2" required>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium">Date of Birth *</label>
                <input type="date" th:field="*{dateOfBirth}" class="w-full border rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-sm font-medium">Gender *</label>
                <select th:field="*{gender}" class="w-full border rounded px-3 py-2" required>
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium">Email</label>
            <input type="email" th:field="*{email}" class="w-full border rounded px-3 py-2">
        </div>

        <div>
            <label class="block text-sm font-medium">Address</label>
            <textarea th:field="*{address}" class="w-full border rounded px-3 py-2"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium">Classroom *</label>
                <select th:field="*{classRoom}" class="w-full border rounded px-3 py-2" required
                        onchange="handleClassChange(this)">
                    <option value="">-- Select Classroom --</option>
                    <option th:each="c : ${classRooms}"
                            th:value="${c.id}"
                            th:text="${c.name}"
                            th:attr="data-code=${c.code}"></option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium">Department *</label>
                <select th:field="*{department}" class="w-full border rounded px-3 py-2" required
                        onchange="handleDepartmentChange(this)">
                    <option value="">-- Select Department --</option>
                    <option th:each="d : ${departments}"
                            th:value="${d.id}"
                            th:text="${d.name}"
                            th:attr="data-code=${d.code}"></option>
                </select>
            </div>
        </div>

        <div id="specialtyField">
            <label class="block text-sm font-medium" id="specialtyLabel">Specialty</label>
            <select th:field="*{specialty}" class="w-full border rounded px-3 py-2" id="specialtySelect">
                <option value="">-- Select Specialty --</option>
                <option th:each="specialty : ${specialties}" th:value="${specialty}" th:text="${specialty}"></option>
            </select>
            <div id="specialtyHelp" class="text-sm text-gray-500 mt-1"></div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium">Academic Year Start *</label>
                <select th:field="*{academicYearStart}" class="w-full border rounded px-3 py-2" required>
                    <option value="">Select Start Year</option>
                    <option th:each="year : ${#numbers.sequence(2020, 2030)}"
                            th:value="${year}" th:text="${year}"></option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium">Academic Year End *</label>
                <select th:field="*{academicYearEnd}" class="w-full border rounded px-3 py-2" required>
                    <option value="">Select End Year</option>
                    <option th:each="year : ${#numbers.sequence(2021, 2031)}"
                            th:value="${year}" th:text="${year}"></option>
                </select>
            </div>
        </div>

        <div class="flex justify-end space-x-3">
            <a th:href="@{/students}" class="px-4 py-2 border rounded">Cancel</a>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Save Changes</button>
        </div>
    </form>
</div>

<script>
    async function updateSpecialtyRequirements(classCode, departmentCode) {
        if (!classCode || !departmentCode) {
            resetSpecialtyField();
            return;
        }

        try {
            const response = await fetch(`/students/check-specialty-requirements?classCode=${classCode}&departmentCode=${departmentCode}`);
            const requirement = await response.json();

            const specialtyField = document.getElementById('specialtyField');
            const specialtyLabel = document.getElementById('specialtyLabel');
            const specialtySelect = document.getElementById('specialtySelect');
            const specialtyHelp = document.getElementById('specialtyHelp');

            if (!requirement.allowed) {
                // Hide specialty field for Forms 1-3 with General department
                specialtyField.style.display = 'none';
                specialtySelect.value = '';
            } else {
                specialtyField.style.display = 'block';

                if (requirement.required) {
                    specialtyLabel.innerHTML = 'Specialty <span class="text-red-500">*</span>';
                    specialtySelect.setAttribute('required', 'required');
                    specialtyHelp.textContent = 'Specialty is required for Sixth Form Science/Arts students';
                    specialtyHelp.className = 'text-sm text-red-500 mt-1';
                } else {
                    specialtyLabel.textContent = 'Specialty';
                    specialtySelect.removeAttribute('required');
                    specialtyHelp.textContent = 'Specialty is optional';
                    specialtyHelp.className = 'text-sm text-gray-500 mt-1';
                }
            }

            // Update specialty options
            updateSpecialtyOptions(requirement.specialties);

        } catch (error) {
            console.error('Error checking specialty requirements:', error);
            resetSpecialtyField();
        }
    }

    function resetSpecialtyField() {
        const specialtyField = document.getElementById('specialtyField');
        const specialtyLabel = document.getElementById('specialtyLabel');
        const specialtySelect = document.getElementById('specialtySelect');
        const specialtyHelp = document.getElementById('specialtyHelp');

        specialtyField.style.display = 'block';
        specialtyLabel.textContent = 'Specialty';
        specialtySelect.removeAttribute('required');
        specialtyHelp.textContent = '';
    }

    function updateSpecialtyOptions(specialties) {
        const specialtySelect = document.getElementById('specialtySelect');

        // Clear existing options except the first one
        while (specialtySelect.options.length > 1) {
            specialtySelect.remove(1);
        }

        // Add new options
        specialties.forEach(specialty => {
            const option = document.createElement('option');
            option.value = specialty;
            option.textContent = specialty;
            specialtySelect.appendChild(option);
        });
    }

    function handleClassChange(select) {
        const selectedOption = select.options[select.selectedIndex];
        const classCode = selectedOption.getAttribute('data-code');
        const departmentSelect = document.querySelector('select[th\\:field="*{department}"]');
        const selectedDeptOption = departmentSelect.options[departmentSelect.selectedIndex];
        const departmentCode = selectedDeptOption.getAttribute('data-code');

        updateSpecialtyRequirements(classCode, departmentCode);
    }

    function handleDepartmentChange(select) {
        const selectedOption = select.options[select.selectedIndex];
        const departmentCode = selectedOption.getAttribute('data-code');
        const classSelect = document.querySelector('select[th\\:field="*{classRoom}"]');
        const selectedClassOption = classSelect.options[classSelect.selectedIndex];
        const classCode = selectedClassOption.getAttribute('data-code');

        updateSpecialtyRequirements(classCode, departmentCode);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const startYearSelect = document.querySelector('select[th\\:field="*{academicYearStart}"]');
        const endYearSelect = document.querySelector('select[th\\:field="*{academicYearEnd}"]');

        if (startYearSelect) {
            startYearSelect.addEventListener('change', function() {
                const startYear = parseInt(this.value);
                if (startYear && !isNaN(startYear)) {
                    endYearSelect.value = startYear + 1;
                }
            });
        }

        // Initialize specialty requirements based on current class and department
        const classSelect = document.querySelector('select[th\\:field="*{classRoom}"]');
        const departmentSelect = document.querySelector('select[th\\:field="*{department}"]');

        if (classSelect && classSelect.value && departmentSelect && departmentSelect.value) {
            const selectedClassOption = classSelect.options[classSelect.selectedIndex];
            const selectedDeptOption = departmentSelect.options[departmentSelect.selectedIndex];
            const classCode = selectedClassOption.getAttribute('data-code');
            const departmentCode = selectedDeptOption.getAttribute('data-code');

            updateSpecialtyRequirements(classCode, departmentCode);
        }
    });
</script>
</body>
</html>